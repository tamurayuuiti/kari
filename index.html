<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ステガノグラフィー - 埋め込まれたデータを抽出</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; color: #333; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 85%; margin: 0 auto; background-color: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 8px; }
        .section { margin-bottom: 40px; }
        .section h3 { color: #444; margin-bottom: 10px; }
        .section p { margin: 5px 0; color: #666; }
        input[type="file"], button { margin-top: 10px; padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; margin-right: 10px; padding: 10px 20px; text-align: center; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #d3d3f3; cursor: not-allowed; }
        .center { display: block; margin-left: auto; margin-right: auto; }
        .image-preview { margin-top: 20px; text-align: center; cursor: pointer; }
        .image-preview img { max-width: 100%; max-height: 400px; height: auto; border: 1px solid #ccc; margin-top: 10px; padding: 10px; background-color: #f1f1f1; display: block; margin-left: auto; margin-right: auto; box-sizing: border-box; }
        .info { font-size: 14px; color: #666; margin-top: 5px; }
        .details { font-size: 14px; margin-top: 10px; color: #333; }
        .warning { color: red; }
        #dropArea, #fileDropArea { border: 2px dashed #ccc; border-radius: 5px; padding: 20px; text-align: center; cursor: pointer; }
        #dropArea.dragging, #fileDropArea.dragging { border-color: #4CAF50; }
        #canvas { display: none; }
        #loadingIndicator, #uploadIndicator { display: none; margin-top: 10px; }
        .loader { border: 6px solid #f3f3f3; border-radius: 50%; border-top: 6px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; display: inline-block; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #progressBarContainer { width: 100%; background-color: #f3f3f3; border: 1px solid #ccc; border-radius: 5px; margin-top: 10px; height: 30px; position: relative; display: flex; justify-content: space-between; align-items: center; }
        #progressBar { height: 100%; width: 0%; background-color: #4CAF50; border-radius: 5px; transition: width 0.3s ease; }
        #progressBarText { position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 14px; line-height: 30px; color: black; font-weight: bold; }
        .bold-info-value { font-weight: bold; color: #333; }
        #progressMessage { margin-top: 10px; font-size: 14px; color: #666; }

        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            body { background-color: #121212; color: #e0e0e0; }
            .container { background-color: #1e1e1e; }
            .section h3 { color: #e0e0e0; }
            .section p, .info, .details { color: #bbbbbb; }
            .image-preview img { border: 1px solid #444; background-color: #333; }
            #dropArea { border-color: #444; }
            #progressBarContainer { background-color: #333; border-color: #444; }
        }
        #previewTextBox { width: 80%; margin-left: auto; margin-right: auto; height: 400px; padding: 10px; border: 1px solid #ccc; overflow-y: scroll; background-color: #f9f9f9; color: #333; white-space: pre-wrap; text-align: left; }
        audio { width: 100%; }

        /* モーダルのスタイル（コンパクトに改行） */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal img { max-width: 90%; max-height: 90%; box-shadow: 0 0 10px white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h3>1. 画像から埋め込まれたデータを抽出</h3>
            <div id="dropArea">
                <p>ここに画像をドラッグ＆ドロップしてください</p>
                <p>または</p>
                <input type="file" id="extractImageInput" accept="image/png, image/jpeg, image/heif">
            </div>

            <button id="extractButton" onclick="extractData()" disabled>データを抽出する</button>
            <button id="downloadButton" style="display:none;" onclick="downloadExtractedData()">抽出されたデータをダウンロード</button>
            <div id="loadingIndicator">
                <div class="loader"></div>
            </div>
            <div id="progressBarContainer" style="display:none;">
                <div id="progressBar">
                    <span id="progressBarText">0%</span>
                </div>
            </div>
            <p id="progressMessage"></p>

            <!-- データの詳細情報をバーよりも下に配置 -->
            <div id="extractedFileInfo" class="info" style="margin-top: 20px;"></div>

            <div id="extractedImageDetails" class="details"></div>
            <canvas id="canvas"></canvas>

            <!-- プレビュー用エリア -->
            <div id="previewArea" class="image-preview" style="display: none;">
                <p>抽出されたデータ:</p>
                <div id="previewContent"></div>
            </div>

        </div>

        <!-- モーダル表示（コンパクトに） -->
        <div class="modal" id="imageModal" onclick="closeModal()">
            <img id="modalImage" src="" alt="拡大画像" />
        </div>
    </div>

    <script>
        let imgData = null;
        let isImageUploaded = false;
        let extractedBlob = null;
        let extractedFileName = '';

        function resetUI() {
            document.getElementById('extractedFileInfo').innerText = '';
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('progressBarContainer').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBarText').innerText = '0%';
            document.getElementById('progressMessage').innerText = '';
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('previewContent').innerHTML = '';
            document.getElementById('downloadButton').style.display = 'none';
            imgData = null;
            isImageUploaded = false;
        }

        function handleImageUpload(file) {
            resetUI();
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    isImageUploaded = true;
                    document.getElementById('extractButton').disabled = false;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('extractImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            handleImageUpload(file);
        });

        function updateProgressBar(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressBarText = document.getElementById('progressBarText');
            progressBar.style.width = percent + '%';
            progressBarText.textContent = percent + '%';
            if (percent === 100) {
                document.getElementById('progressMessage').innerText = 'データ抽出完了';
            } else {
                document.getElementById('progressMessage').innerText = 'データ抽出中';
            }
        }

        function extractData() {
            if (!isImageUploaded) {
                alert("画像がアップロードされていません。");
                return;
            }

            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('progressBarContainer').style.display = 'block';
            updateProgressBar(0);

            let pixelIndex = 0;

            // ファイル名長の抽出（16ビット）
            let fileNameLengthBinary = '';
            for (let i = 0; i < 16; i++) {
                const bit = imgData.data[pixelIndex] & 1;
                fileNameLengthBinary += bit;
                pixelIndex += 1;
                if ((pixelIndex + 1) % 4 === 0) {
                    pixelIndex += 1;  // アルファチャンネルをスキップ
                }
            }
            const fileNameLength = parseInt(fileNameLengthBinary, 2);

            // ファイル名の抽出
            const extractedFileNameBinary = [];
            for (let i = 0; i < fileNameLength; i++) {
                let byte = '';
                for (let j = 0; j < 8; j++) {
                    const bit = imgData.data[pixelIndex] & 1;
                    byte += bit;
                    pixelIndex += 1;
                    if ((pixelIndex + 1) % 4 === 0) {
                        pixelIndex += 1;  // アルファチャンネルをスキップ
                    }
                }
                extractedFileNameBinary.push(parseInt(byte, 2));
            }

            const extractedFileName = binaryStringToUtf8(new Uint8Array(extractedFileNameBinary));
            console.log(`抽出されたファイル名: ${extractedFileName}`);
            document.getElementById('extractedFileInfo').innerText = `ファイル名: ${extractedFileName}`;  // ファイル名を表示

            // データ長の抽出（32ビット）
            let binaryLength = '';
            for (let i = 0; i < 32; i++) {
                const bit = imgData.data[pixelIndex] & 1;
                binaryLength += bit;
                pixelIndex += 1;
                if ((pixelIndex + 1) % 4 === 0) {
                    pixelIndex += 1;  // アルファチャンネルをスキップ
                }
            }
            const dataLength = parseInt(binaryLength, 2);

            // 拡張子長の抽出（8ビット）
            let extLengthBinary = '';
            for (let i = 0; 8 > i; i++) {
                const bit = imgData.data[pixelIndex] & 1;
                extLengthBinary += bit;
                pixelIndex += 1;
                if ((pixelIndex + 1) % 4 === 0) {
                    pixelIndex += 1;  // アルファチャンネルをスキップ
                }
            }
            const extLength = parseInt(extLengthBinary, 2);

            // ファイル拡張子の抽出
            let fileExtension = '';
            for (let i = 0; i < extLength; i++) {
                let charBinary = '';
                for (let j = 0; j < 8; j++) {
                    const bit = imgData.data[pixelIndex] & 1;
                    charBinary += bit;
                    pixelIndex += 1;
                    if ((pixelIndex + 1) % 4 === 0) {
                        pixelIndex += 1;  // アルファチャンネルをスキップ
                    }
                }
                fileExtension += String.fromCharCode(parseInt(charBinary, 2));
            }

            // データ本体の抽出（1000ピクセルずつ分散実行）
            const binaryData = [];
            const chunkSize = 1000;
            function extractChunk(startIndex) {
                for (let i = startIndex; i < Math.min(startIndex + chunkSize, dataLength); i++) {
                    let byte = '';
                    for (let j = 0; j < 8; j++) {
                        const bit = imgData.data[pixelIndex] & 1;
                        byte += bit;
                        pixelIndex += 1;
                        if ((pixelIndex + 1) % 4 === 0) {
                            pixelIndex += 1;  // アルファチャンネルをスキップ
                        }
                    }
                    binaryData.push(parseInt(byte, 2));
                }

                updateProgressBar(Math.round((startIndex / dataLength) * 100));

                if (startIndex + chunkSize < dataLength) {
                    setTimeout(() => extractChunk(startIndex + chunkSize), 0);
                } else {
                    finalizeExtraction(binaryData, fileExtension, extractedFileName);  // 抽出されたファイル名を渡す
                }
            }

            extractChunk(0);
        }

        function finalizeExtraction(binaryData, fileExtension, extractedFileName) {
            // データのプレビュー
            extractedBlob = new Blob([new Uint8Array(binaryData)]);
            previewExtractedData(binaryData, fileExtension);
            updateProgressBar(100);

            // ダウンロードボタンを表示
            document.getElementById('downloadButton').style.display = 'inline-block';
            document.getElementById('loadingIndicator').style.display = 'none';  // 回転インジケータを非表示

            // 容量をKBまたはMBに変換して表示
            const fileSize = formatFileSize(extractedBlob.size);
            let fileInfo = `ファイル名: ${extractedFileName}, 容量: ${fileSize}`;

            // 画像の場合はピクセル数も表示
            if (fileExtension === 'png' || fileExtension === 'jpg' || fileExtension === 'jpeg') {
                const img = new Image();
                img.onload = function() {
                    const width = img.width;
                    const height = img.height;
                    const totalPixels = width * height;
                    const megaPixels = (totalPixels / 1000000).toFixed(2) + ' MP';  // MP単位で表示
                    fileInfo += `, サイズ: ${width}x${height} ピクセル (${megaPixels})`;
                    document.getElementById('extractedFileInfo').innerText = fileInfo;
                };
                img.src = URL.createObjectURL(extractedBlob);
            } else {
                document.getElementById('extractedFileInfo').innerText = fileInfo;
            }
        }

        // 容量をKBまたはMBに変換する関数
        function formatFileSize(size) {
            if (size >= 1048576) {
                return (size / 1048576).toFixed(2) + ' MB';
            } else if (size >= 1024) {
                return (size / 1024).toFixed(2) + ' KB';
            } else {
                return size + ' バイト';
            }
        }

        // 抽出データのプレビュー機能
        function previewExtractedData(binaryData, fileExtension) {
            const previewArea = document.getElementById('previewArea');
            const previewContent = document.getElementById('previewContent');

            if (fileExtension === 'png' || fileExtension === 'jpg' || fileExtension === 'jpeg') {
                // 画像データのプレビュー
                const imageUrl = URL.createObjectURL(extractedBlob);
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.cursor = 'pointer';
                img.onclick = function() {
                    openModal(imageUrl);
                };
                previewContent.appendChild(img);
                previewArea.style.display = 'block';

            } else if (fileExtension === 'wav') {
                // 音声データのプレビュー
                const audioUrl = URL.createObjectURL(extractedBlob);
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = audioUrl;
                previewContent.appendChild(audio);
                previewArea.style.display = 'block';

            } else if (fileExtension === 'txt' || fileExtension === 'json' || fileExtension === 'csv') {
                // テキストデータのプレビュー
                const reader = new FileReader();
                reader.onload = function(event) {
                    const textBox = document.createElement('div');
                    textBox.id = 'previewTextBox';
                    textBox.textContent = event.target.result;
                    previewContent.appendChild(textBox);
                    previewArea.style.display = 'block';
                };
                reader.readAsText(extractedBlob);

            } else {
                // PDFなどその他の形式の場合、プレビューができないことを表示
                const message = document.createElement('p');
                message.style.fontSize = '18px';
                message.style.fontWeight = 'bold';
                message.textContent = `この形式のプレビューはできません。ファイル形式: ${fileExtension}`;
                previewContent.appendChild(message);
                previewArea.style.display = 'block';
            }
        }

        // 抽出データのダウンロード
        function downloadExtractedData() {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(extractedBlob);
            link.download = extractedFileName;  // 抽出されたファイル名でダウンロード
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // UTF-8でデコードしてファイル名を復元
        function binaryStringToUtf8(binaryArray) {
            const decoder = new TextDecoder();
            return decoder.decode(binaryArray);
        }

        // モーダル表示の関数（コードのコンパクト化）
        function openModal(imageUrl) { const modalImage = document.getElementById('modalImage'); modalImage.src = imageUrl; document.getElementById('imageModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('imageModal').style.display = 'none'; }
    </script>
</body>
</html>
